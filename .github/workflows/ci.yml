name: CI

on:
  push:
    branches: ["*"]
  pull_request:

jobs:
  lint-build-test:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode 26.1.1 (if present) or fallback to default
        run: |
          set -euo pipefail
          for candidate in /Applications/Xcode_26.1.1.app /Applications/Xcode_26.1.app /Applications/Xcode.app; do
            if [[ -d "$candidate" ]]; then
              sudo xcode-select -s "$candidate"
              echo "DEVELOPER_DIR=${candidate}/Contents/Developer" >> "$GITHUB_ENV"
              break
            fi
          done
          /usr/bin/xcodebuild -version

      - name: Install Swift 6.2 toolchain
        run: |
          curl -L https://download.swift.org/swift-6.2-release/xcode/swift-6.2-RELEASE/swift-6.2-RELEASE-osx.pkg -o /tmp/swift.pkg
          sudo installer -pkg /tmp/swift.pkg -target /
          echo "/Library/Developer/Toolchains/swift-6.2-RELEASE.xctoolchain/usr/bin" >> "$GITHUB_PATH"
          echo "TOOLCHAINS=swift-6.2-RELEASE" >> "$GITHUB_ENV"

      - name: Install lint tools
        run: brew install swiftlint swiftformat

      - name: SwiftFormat (lint)
        run: swiftformat Sources Tests --lint

      - name: SwiftLint
        run: swiftlint --strict

      - name: Swift Test
        run: swift test --parallel

  build-linux-cli:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Swift 6.2.1
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: "6.2.1"

      - name: Build TrimmyCLI (release, static Swift stdlib)
        run: swift build -c release --product TrimmyCLI --static-swift-stdlib

      - name: Smoke test TrimmyCLI
        shell: bash
        run: |
          set -euo pipefail
          BIN_DIR="$(swift build -c release --product TrimmyCLI --static-swift-stdlib --show-bin-path)"
          BIN="$BIN_DIR/TrimmyCLI"

          "$BIN" --help >/dev/null

          OUT="$(
            printf 'echo hi \\\\\nls -la\n' | "$BIN" --json
          )"

          OUT="$OUT" python3 -c 'import json, os, sys; payload=json.loads(os.environ["OUT"]); trimmed=str(payload.get("trimmed","")); transformed=bool(payload.get("transformed")); ok=transformed and ("\\n" not in trimmed) and ("echo hi" in trimmed) and ("ls -la" in trimmed); (not ok) and print(f"Unexpected result: transformed={transformed!r} trimmed={trimmed!r}", file=sys.stderr); sys.exit(0 if ok else 1)'
